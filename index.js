var fs = require("fs");
var child_process = require("child_process");
var pathExists = require("path-exists");
var Promise = require("bluebird");
function writefile(file, conf, list) {
    for (var i = 0; i < list.length; i++) {
        conf = conf + "\n" + "network={";
        for (var o = 0; o < Object.keys(list[i]).length; o++) {
            conf = conf + "\n" + Object.keys(list[i])[o] + "=" + list[i][Object.keys(list[i])[o]];
        }
        conf = conf + "\n" + "}";
    }
    fs.writeFileSync(file, conf, { encoding: "utf-8" });
}
function fromlinetowpanets(lines) {
    var conf = "";
    var nets = [];
    var net;
    var start = false;
    var firstnet = false;
    var endnetwork = true;
    for (var i = 0; i < lines.length; i++) {
        var checkline = lines[i].replace(/\t/g, "");
        if (checkline[0] != "#" || (checkline[0] == "#" && checkline[3] == "k" && checkline.split("psk").length == 2)) {
            if (checkline.split("etwork").length == 2 && endnetwork) {
                start = true;
                firstnet = true;
                endnetwork = false;
                net = {};
            }
            else if (checkline.replace(/ /g, "")[0] == "}" && firstnet) {
                endnetwork = true;
                firstnet = false;
                nets.push(net);
            }
            else if (firstnet && checkline.split("=").length == 2) {
                net[checkline.split("=")[0].replace(/ /g, "")] = checkline.split("=")[1];
            }
            else if (!start && checkline != "") {
                if (conf != "") {
                    conf = (conf + "\n" + checkline);
                }
                else {
                    conf = (checkline);
                }
            }
        }
    }
    return { list: nets, conf: conf };
}
var WpaMan = (function () {
    function WpaMan(file) {
        this.conf = "";
        if (!pathExists.sync(file)) {
            throw Error("path exists not founded");
        }
        var wpafilelines = fs.readFileSync(file, "utf-8").split("\n");
        var obj = fromlinetowpanets(wpafilelines);
        this.conf = obj.conf;
        this.listwpa = obj.list;
        this.wpasupplicant_path = file;
    }
    WpaMan.prototype.addwpa = function (essid, password, priority) {
        var exist;
        var nets = [];
        var list = this.listwpa;
        var conf = this.conf;
        var file = this.wpasupplicant_path;
        return new Promise(function (resolve, reject) {
            if (password.length < 8) {
                reject("passphrase must be 8 characters minimum");
            }
            else {
                child_process.exec("wpa_passphrase \"" + essid + "\" \"" + password + "\"", function (err, stdout, stderr) {
                    if (err || stderr) {
                        console.log(err);
                        console.log(stderr);
                        reject("error on wpa_passphrase");
                    }
                    var wpafilelines = stdout.toString("utf-8").split('\n');
                    var newnets = fromlinetowpanets(wpafilelines).list;
                    for (var i = 0; i < list.length; i++) {
                        exist = false;
                        for (var l = 0; l < newnets.length; l++) {
                            if (list[i].ssid == newnets[l].ssid) {
                                exist = true;
                            }
                        }
                        if (!exist) {
                            nets.push(list[i]);
                        }
                    }
                    for (var l = 0; l < newnets.length; l++) {
                        nets.push(newnets[l]);
                    }
                    list.length = 0;
                    for (var l = 0; l < nets.length; l++) {
                        list.push(nets[l]);
                    }
                    writefile(file, conf, list);
                    resolve(true);
                });
            }
        });
    };
    WpaMan.prototype.removewpa = function (ssid) {
        var list = this.listwpa;
        var conf = this.conf;
        var file = this.wpasupplicant_path;
        return new Promise(function (resolve, reject) {
            var relist = [];
            var exists = false;
            for (var i = 0; i < list.length; i++) {
                if (list[i].ssid != '"' + ssid + '"') {
                    relist.push(list[i]);
                }
                else {
                    exists = true;
                }
            }
            if (exists) {
                list.length = 0;
                for (var i = 0; i < relist.length; i++) {
                    list.push(relist[i]);
                }
                writefile(file, conf, list);
            }
            resolve(true);
        });
    };
    return WpaMan;
})();
module.exports = WpaMan;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbIndyaXRlZmlsZSIsImZyb21saW5ldG93cGFuZXRzIiwiV3BhTWFuIiwiV3BhTWFuLmNvbnN0cnVjdG9yIiwiV3BhTWFuLmFkZHdwYSIsIldwYU1hbi5yZW1vdmV3cGEiXSwibWFwcGluZ3MiOiJBQUFBLElBQVksRUFBRSxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ3pCLElBQVksYUFBYSxXQUFNLGVBQWUsQ0FBQyxDQUFBO0FBRS9DLElBQVksVUFBVSxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBQzFDLElBQVksT0FBTyxXQUFNLFVBQVUsQ0FBQyxDQUFBO0FBV3BDLG1CQUFtQixJQUFJLEVBQUUsSUFBSSxFQUFFLElBQVk7SUFDdkNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1FBQ25DQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxXQUFXQSxDQUFDQTtRQUNqQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFFbkRBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBRzFGQSxDQUFDQTtRQUVEQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxHQUFHQSxDQUFDQTtJQUU3QkEsQ0FBQ0E7SUFHREEsRUFBRUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsRUFBRUEsUUFBUUEsRUFBRUEsT0FBT0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7QUFFeERBLENBQUNBO0FBR0QsMkJBQTJCLEtBQUs7SUFDNUJDLElBQUlBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBO0lBQ2RBLElBQUlBLElBQUlBLEdBQVdBLEVBQUVBLENBQUNBO0lBQ3RCQSxJQUFJQSxHQUFHQSxDQUFDQTtJQUNSQSxJQUFJQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUNsQkEsSUFBSUEsUUFBUUEsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDckJBLElBQUlBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBO0lBRXRCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtRQUNwQ0EsSUFBSUEsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFHNUNBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLE1BQU1BLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQzVHQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxDQUFDQSxJQUFJQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDdERBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNiQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDaEJBLFVBQVVBLEdBQUdBLEtBQUtBLENBQUNBO2dCQUNuQkEsR0FBR0EsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDYkEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNEQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDbEJBLFFBQVFBLEdBQUdBLEtBQUtBLENBQUNBO2dCQUNqQkEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFFbkJBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLElBQUlBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLE1BQU1BLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUV0REEsR0FBR0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFN0VBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtB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QUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUN4QixDQUFDO2dCQUVELFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRWhDLENBQUM7WUFFRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFakIsQ0FBQyxDQUFDQSxDQUFBQTtJQUNOQSxDQUFDQTtJQUVMSCxhQUFDQTtBQUFEQSxDQTdHQSxBQTZHQ0EsSUFBQTtBQUVELGlCQUFTLE1BQU0sQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgY2hpbGRfcHJvY2VzcyBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcblxuaW50ZXJmYWNlIEl3cGEge1xuXG4gICAgc3NpZDogc3RyaW5nO1xuICAgIHBhc3N3b3JkPzogc3RyaW5nO1xuICAgIGVuY29kZWRQYXNzd29yZDogc3RyaW5nO1xuICAgIHByaW9yaXR5OiBudW1iZXI7XG5cbn1cblxuZnVuY3Rpb24gd3JpdGVmaWxlKGZpbGUsIGNvbmYsIGxpc3Q6IEl3cGFbXSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25mID0gY29uZiArIFwiXFxuXCIgKyBcIm5ldHdvcms9e1wiO1xuICAgICAgICBmb3IgKGxldCBvID0gMDsgbyA8IE9iamVjdC5rZXlzKGxpc3RbaV0pLmxlbmd0aDsgbysrKSB7XG5cbiAgICAgICAgICAgIGNvbmYgPSBjb25mICsgXCJcXG5cIiArIE9iamVjdC5rZXlzKGxpc3RbaV0pW29dICsgXCI9XCIgKyBsaXN0W2ldW09iamVjdC5rZXlzKGxpc3RbaV0pW29dXTtcblxuXG4gICAgICAgIH1cblxuICAgICAgICBjb25mID0gY29uZiArIFwiXFxuXCIgKyBcIn1cIjtcblxuICAgIH1cblxuXG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlLCBjb25mLCB7IGVuY29kaW5nOiBcInV0Zi04XCIgfSk7XG5cbn1cblxuXG5mdW5jdGlvbiBmcm9tbGluZXRvd3BhbmV0cyhsaW5lcykge1xuICAgIGxldCBjb25mID0gXCJcIjtcbiAgICBsZXQgbmV0cyA9IDxJd3BhW10+W107XG4gICAgbGV0IG5ldDtcbiAgICBsZXQgc3RhcnQgPSBmYWxzZTtcbiAgICBsZXQgZmlyc3RuZXQgPSBmYWxzZTtcbiAgICBsZXQgZW5kbmV0d29yayA9IHRydWU7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCBjaGVja2xpbmUgPSBsaW5lc1tpXS5yZXBsYWNlKC9cXHQvZywgXCJcIik7XG5cblxuICAgICAgICBpZiAoY2hlY2tsaW5lWzBdICE9IFwiI1wiIHx8IChjaGVja2xpbmVbMF0gPT0gXCIjXCIgJiYgY2hlY2tsaW5lWzNdID09IFwia1wiICYmIGNoZWNrbGluZS5zcGxpdChcInBza1wiKS5sZW5ndGggPT0gMikpIHtcbiAgICAgICAgICAgIGlmIChjaGVja2xpbmUuc3BsaXQoXCJldHdvcmtcIikubGVuZ3RoID09IDIgJiYgZW5kbmV0d29yaykge1xuICAgICAgICAgICAgICAgIHN0YXJ0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmaXJzdG5ldCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZW5kbmV0d29yayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIG5ldCA9IHt9O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjaGVja2xpbmUucmVwbGFjZSgvIC9nLCBcIlwiKVswXSA9PSBcIn1cIiAmJiBmaXJzdG5ldCkge1xuICAgICAgICAgICAgICAgIGVuZG5ldHdvcmsgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGZpcnN0bmV0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgbmV0cy5wdXNoKG5ldCk7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RuZXQgJiYgY2hlY2tsaW5lLnNwbGl0KFwiPVwiKS5sZW5ndGggPT0gMikge1xuXG4gICAgICAgICAgICAgICAgbmV0W2NoZWNrbGluZS5zcGxpdChcIj1cIilbMF0ucmVwbGFjZSgvIC9nLCBcIlwiKV0gPSBjaGVja2xpbmUuc3BsaXQoXCI9XCIpWzFdO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFzdGFydCAmJiBjaGVja2xpbmUgIT0gXCJcIikge1xuICAgICAgICAgICAgICAgIGlmIChjb25mICE9IFwiXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZiA9IChjb25mICsgXCJcXG5cIiArIGNoZWNrbGluZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZiA9IChjaGVja2xpbmUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICByZXR1cm4geyBsaXN0OiBuZXRzLCBjb25mOiBjb25mIH07XG5cblxufVxuXG5jbGFzcyBXcGFNYW4ge1xuICAgIHdwYXN1cHBsaWNhbnRfcGF0aDogc3RyaW5nO1xuICAgIGxpc3R3cGE6IEl3cGFbXTtcbiAgICBjb25mID0gXCJcIjtcbiAgICBjb25zdHJ1Y3RvcihmaWxlOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCFwYXRoRXhpc3RzLnN5bmMoZmlsZSkpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwicGF0aCBleGlzdHMgbm90IGZvdW5kZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd3BhZmlsZWxpbmVzID0gZnMucmVhZEZpbGVTeW5jKGZpbGUsIFwidXRmLThcIikuc3BsaXQoXCJcXG5cIik7XG5cbiAgICAgICAgbGV0IG9iaiA9IGZyb21saW5ldG93cGFuZXRzKHdwYWZpbGVsaW5lcyk7XG4gICAgICAgIHRoaXMuY29uZiA9IG9iai5jb25mO1xuICAgICAgICB0aGlzLmxpc3R3cGEgPSBvYmoubGlzdDtcblxuICAgICAgICB0aGlzLndwYXN1cHBsaWNhbnRfcGF0aCA9IGZpbGU7XG4gICAgfVxuXG4gICAgYWRkd3BhKGVzc2lkOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIHByaW9yaXR5PzogbnVtYmVyKSB7XG4gICAgICAgIGxldCBleGlzdDtcbiAgICAgICAgbGV0IG5ldHMgPSBbXTtcbiAgICAgICAgbGV0IGxpc3QgPSB0aGlzLmxpc3R3cGE7XG4gICAgICAgIGxldCBjb25mID0gdGhpcy5jb25mO1xuICAgICAgICBsZXQgZmlsZSA9IHRoaXMud3Bhc3VwcGxpY2FudF9wYXRoO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAocGFzc3dvcmQubGVuZ3RoIDwgOCkge1xuICAgICAgICAgICAgICAgIHJlamVjdChcInBhc3NwaHJhc2UgbXVzdCBiZSA4IGNoYXJhY3RlcnMgbWluaW11bVwiKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjaGlsZF9wcm9jZXNzLmV4ZWMoXCJ3cGFfcGFzc3BocmFzZSBcXFwiXCIgKyBlc3NpZCArIFwiXFxcIiBcXFwiXCIgKyBwYXNzd29yZCArIFwiXFxcIlwiLCBmdW5jdGlvbihlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIgfHwgc3RkZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3RkZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChcImVycm9yIG9uIHdwYV9wYXNzcGhyYXNlXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IHdwYWZpbGVsaW5lcyA9IHN0ZG91dC50b1N0cmluZyhcInV0Zi04XCIpLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld25ldHMgPSBmcm9tbGluZXRvd3BhbmV0cyh3cGFmaWxlbGluZXMpLmxpc3Q7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbCA9IDA7IGwgPCBuZXduZXRzLmxlbmd0aDsgbCsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RbaV0uc3NpZCA9PSBuZXduZXRzW2xdLnNzaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXhpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXRzLnB1c2gobGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGwgPSAwOyBsIDwgbmV3bmV0cy5sZW5ndGg7IGwrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV0cy5wdXNoKG5ld25ldHNbbF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbGlzdC5sZW5ndGggPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGwgPSAwOyBsIDwgbmV0cy5sZW5ndGg7IGwrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKG5ldHNbbF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICB3cml0ZWZpbGUoZmlsZSwgY29uZiwgbGlzdCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICByZW1vdmV3cGEoc3NpZDogc3RyaW5nKSB7XG5cbiAgICAgICAgbGV0IGxpc3QgPSB0aGlzLmxpc3R3cGE7XG4gICAgICAgIGxldCBjb25mID0gdGhpcy5jb25mO1xuICAgICAgICBsZXQgZmlsZSA9IHRoaXMud3Bhc3VwcGxpY2FudF9wYXRoO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuICAgICAgICAgICAgbGV0IHJlbGlzdCA9IDxJd3BhW10+W107XG4gICAgICAgICAgICBsZXQgZXhpc3RzID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGxpc3RbaV0uc3NpZCAhPSAnXCInICsgc3NpZCArICdcIicpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVsaXN0LnB1c2gobGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZXhpc3RzID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGV4aXN0cykge1xuICAgICAgICAgICAgICAgIGxpc3QubGVuZ3RoID0gMDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlbGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBsaXN0LnB1c2gocmVsaXN0W2ldKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHdyaXRlZmlsZShmaWxlLCBjb25mLCBsaXN0KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlKHRydWUpXG5cbiAgICAgICAgfSlcbiAgICB9XG5cbn1cblxuZXhwb3J0ID0gV3BhTWFuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
